## OKX Order Book File Documentation

This document describes the format of OKX order book files generated by your system.

### File Format

- Follow the /okx/ob/\<*instrument*\>/\<*first_timestamp_ms*\>.mm file pattern
- Use a [memory mappable](https://numpy.org/doc/stable/reference/generated/numpy.memmap.html) format.Â 

#### Order Book Data:
- All data are stored as `float` precison floating number aka `np.float32`
- The order book data is stored in a 3d memory-mapped NumPy array with a fixed shape of `(-1, 50, 3)`.

#### Timestamp Index:
A separate file stores the timestamps corresponding to each order book snapshot. This file is also memory-mapped for efficient access using long datatype (`np.int64`).

### Dimensions of the order book data

* **-1**: Represents the number of snapshots in the file. This will vary depending on the data collection frequency.
* **50** *(25 + 25)*: Represents the maximum number of bids and asks stored.
* **3**: Represents the three columns of data for each entry:
    * **0 (price)**: Price (float32)
    * **1 (volume)**: Total order volume (float32)
    * **2 (count)**: Total number of orders (float32)

### Data Generation

The order book data is collected every 15 seconds from the OKX WebSocket feed. The raw order book data is aggregated into a fixed-size order book using a top-k selection algorithm based on price and volume. The top 25 bids and asks are selected and stored in the file.

### Code Snippet for Loading Data

**Python**

```python
from path import Path
import numpy as np

from enum import IntEnum

class OB_COLUMNS(IntEnum):
    price = 0
    volume = 1
    count = 2
    end = 3

def get_ob_shape():
    return 2 * 25, int(OB_COLUMNS.end)

def load_ob_data(symbol, path=None, shape=None, prefix="okx_ob_"):
    """
    Loads OKX order book data from a memory-mapped file.

    Args:
        symbol (str): The symbol for the order book data.
        path (str, optional): The path to the data file. Defaults to None.
            If None, the data will be loaded from the base path defined in a 
            separate configuration.
        shape (tuple, optional): The expected shape of the data. Defaults to None.
            If None, the shape will be inferred from the file.
        prefix (str, optional): The prefix of the data file name. Defaults to "okx_ob_".

    Returns:
        tuple: A tuple containing two elements:
            * time (np.ndarray[np.int64]): An array of timestamps for each snapshot.
            * data (np.ndarray[np.float64, ndim=3]): The order book data in a NumPy array.
    """
    
    path_obj = Path(path if path else '.')
    data_path = path_obj / f"{prefix}{symbol}.mm"
    time_path = path_obj / f"{prefix}{symbol}.mm.time"

    # Load data and time arrays using memory mapping
    data = np.memmap(data_path, dtype=np.float32, mode="r").reshape(-1, *(shape if shape else get_ob_shape()))
    time = np.memmap(time_path, dtype=np.int64, mode="r")

    assert len(data) == len(time), f"{len(data)} != {len(time)}"

    return time, data